import React, { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import VideoCard from "../components/VideoCard";
import styles from "./Videos.module.css";
import { useParams } from "react-router-dom";
import LoadingVideoCard from "../components/loading/LoadingVideoCard";
import fetch_popular from "../apis/popular";
import fetch_keyword from "../apis/keyword";
import fetch_channel from "../apis/channel";

export default function Videos() {
  const [state, setState] = useState({ title: "", channelTitle: "" });
  const { keyword } = useParams();

  const fetchData = async () => {
    if (keyword) {
      const data = await fetch_keyword(keyword);
      const new_data = data.items.map((item) => ({
        ...item,
        snippet: {
          ...item.snippet,
          // channelImg: fetch_channel(item.id.videoId).items[0].snippet.thumbnails.default.url,
          channleImg: "임시로 넣는 채널이미지url",
        },
      }));
      return new_data;
    } else {
      const data = await fetch_popular();
      const new_data = data.items.map((item) => ({
        ...item,
        snippet: {
          ...item.snippet,
          // channelImg: fetch_channel(item.id).items[0].snippet.thumbnails.default
          //   .url,
          channleImg: "임시로 넣는 채널이미지url",
        },
      }));
      return new_data;
    }
  };

  const { isLoading, error, data } = useQuery(["videos", keyword], fetchData, {
    staleTime: 1000 * 60 * 5,
  });

  const onClick = (e) => {
    setState((prev) => ({
      title: e.target.title,
      channelTitle: e.target.channelTitle,
    }));
  };

  if (isLoading)
    return (
      <section className={styles.container}>
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
        <LoadingVideoCard />
      </section>
    );

  if (error) return <p>{error}</p>;

  return (
    <section className={styles.container}>
      {data.items.map((item) => (
        <VideoCard
          key={keyword ? item.id.videoId : item.id}
          id={keyword ? item.id.videoId : item.id}
          thumUrl={item.snippet.thumbnails.medium.url}
          title={item.snippet.title}
          channelTitle={item.snippet.channelTitle}
          channelImg={item.snippet.channelImg}
          onClick={(e) => onClick(e)}
        />
      ))}
    </section>
  );
}
